<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>장르 분포 비교</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'main/css/navbar.css' %}">
    <link rel="stylesheet" href="{% static 'chart/css/genre_distribution_view.css' %}">
</head>
<body>
    {% include 'navbar.html' %}

    <!-- 타이틀 한글로 수정 -->
    <h2>장르 분포 비교</h2>

    <!-- 첫 번째 줄: Popular, Customer 차트 두 개 가로 배치 -->
    <div class="chart-row">
        <div class="chart-item">
            <canvas id="genreChart"></canvas>
            <div class="chart-label">인기 장르 분포</div>
        </div>
        <div class="chart-item">
            <canvas id="custGenreChart"></canvas>
            <div class="chart-label">고객 장르 분포</div>
        </div>
    </div>

    <!-- 예측 모델 타이틀 한글로 수정 -->
    <h3 class="prediction-title">예측 모델</h3>

    <!-- 두 번째 줄: SVD, NMF, MF 차트 세 개 가로 배치 -->
    <div class="chart-row second-row">
        <div class="chart-item">
            <canvas id="svdGenreChart"></canvas>
            <div class="chart-label">SVD 장르 분포</div>
        </div>
        <div class="chart-item">
            <canvas id="nmfGenreChart"></canvas>
            <div class="chart-label">NMF 장르 분포</div>
        </div>
        <div class="chart-item">
            <canvas id="mfGenreChart"></canvas>
            <div class="chart-label">행렬 분해 장르 분포</div>
        </div>
    </div>

    <script>
    const labels = ['Action', 'Comedy', 'Drama', 'Horror', 'Romance', 'Sci-Fi', 'Thriller', 'Fantasy', 'Documentary', 'Adventure'];

    async function fetchGenreData() {
        const response = await fetch('{% url "chart:pop_chart" %}');
        return response.json();
    }

    async function fetchCustGenreData() {
        const response = await fetch('{% url "chart:cust_chart" %}');
        return response.json();
    }

    async function fetchSvdGenreData() {
        const response = await fetch('{% url "chart:svd_chart" %}');
        return response.json();
    }

    async function fetchNmfGenreData() {
        const response = await fetch('{% url "chart:nmf_chart" %}');
        return response.json();
    }

    async function fetchMfGenreData() {
        const response = await fetch('{% url "chart:mf_chart" %}');
        return response.json();
    }

    function alignDataWithLabels(data) {
        const alignedData = labels.map(label => data[label] || 0);
        return alignedData;
    }

    function drawChart(chartId, genreData, chartType = 'default') {
        const ctx = document.getElementById(chartId).getContext('2d');
        const alignedData = alignDataWithLabels(genreData);

        let colors;
        if (chartType === 'popular') {
        colors = [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(100, 149, 237, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(144, 238, 144, 0.2)',
                'rgba(210, 105, 30, 0.2)',
                'rgba(70, 130, 180, 0.2)'
            ];
        } else {
            colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(100, 149, 237, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(144, 238, 144, 0.8)',
                'rgba(210, 105, 30, 0.8)',
                'rgba(70, 130, 180, 0.8)'
            ];
        }

        const genreChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: alignedData,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color.replace('0.2', '1').replace('0.8', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        color: '#000',
                        formatter: (value, context) => {
                            return context.chart.data.labels[context.dataIndex];
                        },
                        font: {
                            size: 14,
                            weight: 'bold' /* 글자 두께를 굵게 설정 */
                        },
                        textAlign: 'center'
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const genreData = await fetchGenreData();
        drawChart('genreChart', genreData, 'popular');

        const custGenreData = await fetchCustGenreData();
        drawChart('custGenreChart', custGenreData);

        const svdGenreData = await fetchSvdGenreData();
        drawChart('svdGenreChart', svdGenreData, 'svd');

        const nmfGenreData = await fetchNmfGenreData();
        drawChart('nmfGenreChart', nmfGenreData, 'nmf');

        const mfGenreData = await fetchMfGenreData();
        drawChart('mfGenreChart', mfGenreData, 'mf');
    });
</script>

</body>
</html>
